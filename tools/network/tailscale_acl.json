{
  // Tailscale ACL (Access Control List) for Agrobot TOM v2
  //
  // This file is pasted into: https://login.tailscale.com/admin/acls
  //
  // Design principles:
  //   1. Principle of least privilege — nodes only expose the ports they need.
  //   2. Tag-based rules — we use tags (not IP addresses) so the policy
  //      remains valid even when a machine is replaced or its IP changes.
  //   3. ROS 2 DDS ports are explicitly enumerated — DDS uses a range of
  //      ephemeral ports; we open the standard range for our domain ID.
  //
  // ROS 2 DDS Port Calculation (for ROS_DOMAIN_ID=42):
  //   Discovery server port  = 7400 + (250 * domain_id) + 0  = 17900
  //   User traffic base      = 7400 + (250 * domain_id) + 1  = 17901
  //   Ephemeral range        = 32768–60999 (Linux default)
  //   We open 17900-17910 for DDS discovery + a unicast data range.

  // ── NETWORK TOPOLOGY NOTE ─────────────────────────────────────────────────
  // NYU HPC Greene is accessed via Cisco AnyConnect VPN (NYU-NET).
  // AnyConnect is hub-and-spoke and conflicts with Tailscale's WireGuard UDP.
  // Greene compute nodes also have no direct internet egress.
  //
  // RESULT: HPC is NOT on the Tailscale mesh. It is accessed exclusively via:
  //   - SSH over AnyConnect VPN (interactive)
  //   - scp/rsync over AnyConnect (model artifact transfer)
  //
  // Only local Mac ↔ AMD Edge require Tailscale (for live ROS 2 DDS).
  // ──────────────────────────────────────────────────────────────────────────

  "tagOwners": {
    "tag:dev":      ["autogroup:owner"],  // local Mac (AI/Systems engineer machine)
    "tag:robot":    ["autogroup:owner"],  // AMD edge robot computer
    "tag:ci":       ["autogroup:owner"]   // Future: CI/CD runner
    // tag:hpc intentionally omitted — HPC uses AnyConnect, not Tailscale
  },

  "acls": [
    // ── Dev machine (local Mac) → Robot ───────────────────────────────────
    {
      "action": "accept",
      "src":    ["tag:dev"],
      "dst":    ["tag:robot"],
      "proto":  "tcp",
      "ports":  ["22", "9090"]
      // 22   = SSH
      // 9090 = rosbridge_websocket (Foxglove Studio)
    },

    // ── ROS 2 DDS — Dev ↔ Robot (bidirectional) ───────────────────────────
    // This is the critical path: live ROS 2 topics across the Tailscale mesh.
    {
      "action": "accept",
      "src":    ["tag:dev", "tag:robot"],
      "dst":    ["tag:dev", "tag:robot"],
      "proto":  "udp",
      "ports":  ["17900-17910", "7400-7500"]
    },
    {
      "action": "accept",
      "src":    ["tag:dev", "tag:robot"],
      "dst":    ["tag:dev", "tag:robot"],
      "proto":  "tcp",
      "ports":  ["17900-17910", "7400-7500"]
    },

    // ── Deny everything else ──────────────────────────────────────────────
    // Tailscale's default is deny-all. This comment is here as a reminder —
    // no explicit deny rule is needed; anything not matched above is blocked.
    {
      "action": "accept",
      "src":    ["autogroup:member"],
      "dst":    ["autogroup:self"],
      "proto":  "*"
      // Every machine can always reach itself (loopback equivalence).
    }
  ],

  // MagicDNS: gives each machine a stable hostname on the tailnet.
  // After setup: `ssh amd-edge` works from anywhere (over Tailscale).
  // HPC Greene is accessed via `ssh greene` (AnyConnect VPN, NOT Tailscale).
  "dnsConfig": {
    "domains":        ["agrobot.ts.net"],
    "nameservers":    ["100.100.100.100"],  // Tailscale's internal DNS resolver
    "disableIPv4":    false,
    "disableIPv6":    false
  },

  // Hostnames to set for each tagged machine.
  // Set these in the Tailscale admin panel → Machines → Edit name.
  // Recommended names (document here for reference):
  //   local-mac    → the AI/Systems engineer's development machine
  //   hpc-greene   → NYU HPC login node (or a specific compute node)
  //   amd-edge     → the AMD 96GB microcomputer

  "ssh": [
    // Allow SSH via Tailscale SSH (no separate key management needed).
    // Only tag:dev → tag:robot — HPC is NOT on Tailscale (uses AnyConnect VPN).
    {
      "action": "accept",
      "src":    ["tag:dev"],
      "dst":    ["tag:robot"],
      "users":  ["autogroup:nonroot"]
    }
  ]
}
